## Render Blueprint — https://render.com/docs/blueprint-spec
##
## Provisions:
##   - ernesto-api   Web Service (Docker, free tier)
##   - ernesto-db    PostgreSQL database (free tier)
##   - ernesto-redis Redis (free tier)
##
## Deploy:
##   1. Push this file to your GitHub repo
##   2. Go to https://dashboard.render.com → New → Blueprint
##   3. Connect your repo — Render reads this file automatically
##   4. Fill in the required env vars marked sync: false below

services:

  # ------------------------------------------------------------------
  # Backend API
  # ------------------------------------------------------------------
  - type: web
    name: ernesto-api
    runtime: docker
    dockerfilePath: ./Dockerfile
    region: frankfurt          # change to: oregon, ohio, singapore, virginia
    plan: free                 # upgrade to starter ($7/mo) for always-on
    healthCheckPath: /docs
    envVars:
      - key: LOCAL_DEV
        value: "false"

      # --- Database (auto-filled from the postgres block below) ---
      - key: DATABASE_URL
        fromDatabase:
          name: ernesto-db
          property: connectionString

      # --- Redis (auto-filled from the redis block below) ---
      - key: REDIS_URL
        fromService:
          name: ernesto-redis
          type: redis
          property: connectionString

      # --- Secrets: set these in the Render dashboard ---
      - key: OPENAI_API_KEY
        sync: false            # you must set this manually in the dashboard

      - key: SECRET_KEY
        generateValue: true    # Render auto-generates a secure random value

      - key: CORS_ORIGINS
        sync: false            # e.g. https://your-frontend.onrender.com

      # --- Auth (Supabase) — required when LOCAL_DEV=false ---
      - key: SUPABASE_URL
        sync: false            # e.g. https://xxxx.supabase.co
      - key: SUPABASE_JWT_SECRET
        sync: false            # Supabase dashboard → Settings → API → JWT Secret

      # --- Storage (S3) — leave blank to use ephemeral local storage ---
      - key: S3_BUCKET
        sync: false
      - key: CLOUDFRONT_DOMAIN
        sync: false
      - key: AWS_REGION
        value: "us-east-1"
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false

      # --- Encryption ---
      - key: FERNET_KEY
        generateValue: false   # generate manually: see README
        sync: false

      # --- eBay ---
      - key: EBAY_APP_ID
        sync: false
      - key: EBAY_CERT_ID
        sync: false
      - key: EBAY_DEV_ID
        sync: false
      - key: EBAY_USER_TOKEN
        sync: false
      - key: EBAY_SANDBOX
        value: "true"

  # ------------------------------------------------------------------
  # PostgreSQL
  # ------------------------------------------------------------------
  - type: pserv
    name: ernesto-db
    runtime: postgres
    region: frankfurt
    plan: free
    databaseName: ernesto
    databaseUser: ernesto

  # ------------------------------------------------------------------
  # Redis
  # ------------------------------------------------------------------
  - type: redis
    name: ernesto-redis
    region: frankfurt
    plan: free
    maxmemoryPolicy: allkeys-lru
